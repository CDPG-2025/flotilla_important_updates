Flotilla Distributed Setup (Multi-Machine)
========================================

This document explains how to run Flotilla when the Server and Clients are on **different physical machines**.

1. Prerequisites & Networking
-----------------------------
- **Server Machine IP**: Let's assume the Server's IP is `192.168.1.100`.
- **Client Machine IP**: Let's assume the Client's IP is `192.168.1.200`.

### Firewall / Ports
- **On Server Machine**:
  - Allow Inbound TCP on Port **1884** (MQTT Broker).
  - Allow Inbound TCP on Port **12345** (REST API for Session Start).
  - Allow Inbound TCP on Port **6379** (Redis, if Clients need direct access, though usually only Server needs this).
- **On Client Machine**:
  - Allow Inbound TCP on Ports **50053** and **50054** (gRPC Sync/Async).
  - *Note: If running multiple clients on one machine, open the subsequent ports too (50055, 50056, etc).*

### ⚠️ IMPORTANT FOR VM USERS (VirtualBox / VMware) ⚠️
If your Server IP looks like `10.0.2.15`, you are using **NAT**. The Client machine **CANNOT** connect to this IP.
1. **Shut down** your VM.
2. Go to **Settings > Network**.
3. Change "Attached to" from **NAT** to **Bridged Adapter**.
4. Restart the VM.
5. Run `hostname -I` again. You should now get an IP like `192.168.0.xxx` (same range as your Client).
**Use THIS new IP for all commands.**

2. Server Machine Setup
-----------------------
The Server hosts the infrastructure (MQTT, Redis) and the Leader process.

### A. Start Infrastructure
Run the Docker containers for MQTT and Redis.
```bash
cd /path/to/flotilla/docker
docker-compose up -d
```

### B. Start Server
```bash
cd /path/to/flotilla/src
python flo_server.py
```
*The server will bind to 0.0.0.0 (all interfaces) by default for the REST API, so it should be accessible.*

3. Client Machine Setup
-----------------------
The Client machine runs the worker process. It does **NOT** need to run `docker-compose`.

### A. Start Client with Server IP
You can now specify the Server's IP (MQTT Broker) directly via the command line, without editing config files.

Run the client script:
```bash
cd /path/to/flotilla/src
python flo_client.py --client-num 1 --server-ip 192.168.1.100
```
*Replace `192.168.1.100` with your actual Server IP.*

*Note: You can use `--client-num 1` on every distinct machine, as long as they are on different IPs. The Server identifies them by their unique UUIDs (generated automatically).*

4. Running a Session
--------------------
You can run the session script from the **Server Machine** (or any machine that can reach the Server's REST API).

```bash
cd /path/to/flotilla/src
python flo_session.py ../config/flotilla_quicksetup_config.yaml --federated_server_endpoint 192.168.1.100:12345
```
*Note: Replace `192.168.1.100` with `localhost` if running this command on the Server machine itself.*
